// index.html (named such for phone gap build purposes)
// Matthew Olsson 10/10/2014
// JoyShtick.js Library 
// http://joyshtickblog.blogspot.com/

<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, 
    user-scalable=no, initial-scale=1, maximum-scale=1, user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style type="text/css">
	body { margin: 0; padding: 0; background: #000;}
	//canvas { display: block; margin: 0 auto; background: #fff; }
	#baseleft{
		display: block;
		background: #ffffff;
		margin: 0 auto;
     	position:absolute;
     	z-index: 0;
     	left: 0px;
     	top: 0px;
    }
    #baseright{
		display: block;
		background: #ffffff;
     	position:absolute;
     	z-index: 0;
     	left: 0px;
     	top: 0px;
    }
    #topleft{
    	display: block;
		margin: 0 auto;
  		background: rgba(0,0,0,0);
  		position: absolute;
  		left: 0px;
  		top: 0px;
  		z-index: 1;
  		cursor: pointer;
  	}
</style>
<script>

	window.onload = init;

	// globals
	var initialPoint, endPoint, dragging = false, canvasBaseLeft, canvasTopLeft, canvasBaseRight, ctxbaseleft, ctxtopleft, ctxbaseright, buttons, timeOfLastPress;
	// used for joystick calculations
	var xdistance,ydistance,totalDistance,adjustedX,properY;

	// constants
	// TODO - change size of joystick to be responsive to screen size
	var RADIUS_OF_JOYSTICK_BASE = 40, RADIUS_OF_JOYSTICK = 25;

	function init() {

		// initializes canvases
		canvasBaseLeft = document.getElementById("baseleft");
		ctxbaseleft = canvasBaseLeft.getContext("2d");
		ctxbaseleft.canvas.width  = window.innerWidth/2;
		ctxbaseleft.canvas.height = window.innerHeight;
		ctxbaseleft.clearRect (0,0,ctxbaseleft.canvas.width,ctxbaseleft.canvas.height); 

		canvasTopLeft = document.getElementById("topleft");
		ctxtopleft = canvasTopLeft.getContext("2d");
		ctxtopleft.canvas.width  = window.innerWidth/2;
		ctxtopleft.canvas.height = window.innerHeight;
		ctxtopleft.clearRect(0,0,ctxtopleft.canvas.width,ctxtopleft.canvas.height);

		canvasBaseRight = document.getElementById("baseright");
		ctxbaseright = canvasBaseRight.getContext("2d");
		ctxbaseright.canvas.width  = window.innerWidth/2;
		ctxbaseright.canvas.height = window.innerHeight;
		ctxbaseright.clearRect(0,0,ctxbaseright.canvas.width,ctxbaseright.canvas.height);
		canvasBaseRight.style.marginLeft = window.innerWidth/2; 

		// listen for touches
		canvasTopLeft.addEventListener('touchstart', function(e) { e.preventDefault(); }, false);

		canvasTopLeft.addEventListener('touchmove', function(e) {
			e.preventDefault();
			dragging = true;
			if(initialPoint === undefined){
				initialPoint = {x: e.touches[0].clientX, y: e.touches[0].clientY};
				// draws base of joystick
				ctxbaseleft.beginPath();
			    ctxbaseleft.arc(initialPoint.x, initialPoint.y, RADIUS_OF_JOYSTICK_BASE, 0, 2 * Math.PI, false);
			    ctxbaseleft.lineWidth = 5;
			    ctxbaseleft.strokeStyle = "rgba(111, 111, 111, .5)";
			    ctxbaseleft.stroke();
			}

			endPoint = {x: e.touches[0].clientX, y: e.touches[0].clientY};
			drawJoyStickTop(initialPoint,endPoint);
		}, false);

		canvasTopLeft.addEventListener('touchend', function(e) {
			e.preventDefault();
			if(dragging){
				dragging = false;
				initialPoint = undefined;
				ctxbaseleft.clearRect (0,0,ctxbaseleft.canvas.width,ctxbaseleft.canvas.height);
				ctxtopleft.clearRect(0,0,ctxtopleft.canvas.width,ctxtopleft.canvas.height);
			}
		}, false);

		canvasBaseRight.addEventListener('touchstart', function(e){
			pressButton();
		}, false);

		canvasBaseRight.addEventListener('touchend', function(e){
			pressButton();
		}, false);

		/*window.onresize = function(){
			ctxbaseleft.canvas.width  = window.innerWidth;
			ctxbaseleft.canvas.height = window.innerHeight;
		};*/
	}

	function drawJoyStickTop(initialPoint,currentPoint){
		xdistance = currentPoint.x-initialPoint.x;
		ydistance = currentPoint.y-initialPoint.y;
		totalDistance = (xdistance*xdistance+ydistance*ydistance);
		adjustedX = currentPoint.x,adjustedY = currentPoint.y; // if inside base circle no adjustments needed
		// if the top joystick is outside of the base circle
		if(totalDistance > 1600){ 
			// calculates the x and y offsets from the origin of the base joystick
			changeX = (RADIUS_OF_JOYSTICK_BASE)/Math.sqrt(1 + ((ydistance*ydistance)/(xdistance*xdistance)));
			changeY = Math.sqrt(RADIUS_OF_JOYSTICK_BASE*RADIUS_OF_JOYSTICK_BASE - changeX*changeX);
			// adjusts the offsets for all four quadrants of the circle
			changeX = changeX*xdistance/Math.abs(xdistance);
			changeY = changeY*ydistance/Math.abs(ydistance);
			// overwriting the top joysticks positions with the appropriate adjustments
			adjustedX = initialPoint.x + changeX;
			adjustedY = initialPoint.y + changeY;
		}
		ctxtopleft.clearRect(0,0,ctxtopleft.canvas.width,ctxtopleft.canvas.height);
		ctxtopleft.beginPath();
	    ctxtopleft.arc(adjustedX, adjustedY, RADIUS_OF_JOYSTICK, 0, 2 * Math.PI, false);
	    ctxtopleft.lineWidth = 5;
	    ctxtopleft.fillStyle = "rgba(111, 111, 111, .5)";
	    ctxtopleft.fill();
	    ctxtopleft.strokeStyle = "rgba(111, 111, 111, .5)";
	    ctxtopleft.stroke();
	}
	// versatile: user can provide as many parameters as they want and it will set the rest to undefined
	function addButton(userInputX,userInputY,userInputFunction,userInputColor,userInputShape){
		buttons[buttons.length] = {x:userInputX,y:userInputY,function:userInputFunction,color:userInputColor,shape:userInputShape}
		drawButtons;
	}
	// draw buttons
	function drawButtons(){

	}
	// press button
	function pressButton(){

	}
	// release button
	function releaseButton(){

	}

</script>
</head>
<body>
	<canvas id="topleft">
		Your browser does not support the HTML5 canvas tag.
	</canvas>
	<canvas id="baseleft">
		Your browser does not support the HTML5 canvas tag.
	</canvas>
	<canvas id="baseright">
		Your browser does not support the HTML5 canvas tag.
	</canvas>
</body>
</html>