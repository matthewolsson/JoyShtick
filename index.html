// index.html (named such for phone gap build purposes)
// Matthew Olsson 10/10/2014
// JoyShtick.js Library 
// http://joyshtickblog.blogspot.com/

<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, 
    user-scalable=no, initial-scale=1, maximum-scale=1, user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style type="text/css">
	body { margin: 0; padding: 0; background: #000;}
	//canvas { display: block; margin: 0 auto; background: #fff; }
	#base {
		display: block;
		background: #ffffff;
		margin: 0 auto;
     	position:absolute;
     	z-index: 0;
     	left: 0px;
     	top: 0px;
    }
    #top{
    	display: block;
		margin: 0 auto;
  		background: rgba(0,0,0,0);
  		position: absolute;
  		left: 0px;
  		top: 0px;
  		z-index: 1;
  		cursor: pointer;
  	}
</style>
<script>

	window.onload = init;

	// globals
	var initialPoint, endPoint, dragging = false, c, c2, ctxbase, ctxtop;
	// used for joystick calculations
	var xdistance,ydistance,totalDistance,adjustedX,properY;

	// constants
	var RADIUS_OF_JOYSTICK_BASE = 40, RADIUS_OF_JOYSTICK = 25;

	function init() {

		c = document.getElementById("base");
		ctxbase = c.getContext("2d");
		ctxbase.canvas.width  = window.innerWidth;
		ctxbase.canvas.height = window.innerHeight;
		ctxbase.clearRect (0,0,ctxbase.canvas.width,ctxbase.canvas.height); 


		c2 = document.getElementById("top");
		ctxtop = c2.getContext("2d");
		ctxtop.canvas.width  = window.innerWidth;
		ctxtop.canvas.height = window.innerHeight;
		ctxtop.clearRect(0,0,ctxtop.canvas.width,ctxtop.canvas.height);

		// listen for touches
		window.addEventListener('touchstart', function(e) 
		{
			e.preventDefault();
		}, false);

		window.addEventListener('touchmove', function(e) 
		{
			e.preventDefault();
			dragging = true;
			if(initialPoint === undefined){
				initialPoint = {x: e.touches[0].clientX, y: e.touches[0].clientY};
				// draws base of joystick
				ctxbase.beginPath();
			    ctxbase.arc(initialPoint.x, initialPoint.y, RADIUS_OF_JOYSTICK_BASE, 0, 2 * Math.PI, false);
			    ctxbase.lineWidth = 5;
			    ctxbase.strokeStyle = "rgba(111, 111, 111, .5)";
			    ctxbase.stroke();
			}

			endPoint = {x: e.touches[0].clientX, y: e.touches[0].clientY};
			drawJoyStickTop(initialPoint,endPoint);
		}, false);

		window.addEventListener('touchend', function(e) 
		{
			e.preventDefault();
			if(dragging){
				dragging = false;
				initialPoint = undefined;
				ctxbase.clearRect (0,0,ctxbase.canvas.width,ctxbase.canvas.height);
				ctxtop.clearRect(0,0,ctxtop.canvas.width,ctxtop.canvas.height);
			}
		}, false);

		/*window.onresize = function(){
			ctxbase.canvas.width  = window.innerWidth;
			ctxbase.canvas.height = window.innerHeight;
		};*/
	}

	function drawJoyStickTop(initialPoint,currentPoint){
		xdistance = currentPoint.x-initialPoint.x;
		ydistance = currentPoint.y-initialPoint.y;
		totalDistance = (xdistance*xdistance+ydistance*ydistance);
		adjustedX = currentPoint.x,adjustedY = currentPoint.y; // if inside base circle no adjustments needed
		// if the top joystick is outside of the base circle
		if(totalDistance > 1600){ 
			// calculates the x and y offsets from the origin of the base joystick
			changeX = (RADIUS_OF_JOYSTICK_BASE)/Math.sqrt(1 + ((ydistance*ydistance)/(xdistance*xdistance)));
			changeY = Math.sqrt(RADIUS_OF_JOYSTICK_BASE*RADIUS_OF_JOYSTICK_BASE - changeX*changeX);
			// adjusts the offsets for all four quadrants of the circle
			changeX = changeX*xdistance/Math.abs(xdistance);
			changeY = changeY*ydistance/Math.abs(ydistance);
			// overwriting the top joysticks positions with the appropriate adjustments
			adjustedX = initialPoint.x + changeX;
			adjustedY = initialPoint.y + changeY;
		}
		ctxtop.clearRect(0,0,ctxtop.canvas.width,ctxtop.canvas.height);
		ctxtop.beginPath();
	    ctxtop.arc(adjustedX, adjustedY, RADIUS_OF_JOYSTICK, 0, 2 * Math.PI, false);
	    ctxtop.lineWidth = 5;
	    ctxtop.fillStyle = "rgba(111, 111, 111, .5)";
	    ctxtop.fill();
	    ctxtop.strokeStyle = "rgba(111, 111, 111, .5)";
	    ctxtop.stroke();
	}

</script>

</head>

<body>
	<canvas id="base">
		Your browser does not support the HTML5 canvas tag.
	</canvas>
	<canvas id="top">
		Your browser does not support the HTML5 canvas tag.
	</canvas>
</body>

</html>